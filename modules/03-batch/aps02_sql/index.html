<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    
      
        <title>Aps02 sql - MLOps & Interviews</title>
      
    
    <link rel="stylesheet"
      href="https://fonts.googleapis.com/css?family=Fira+Sans+Extra+Condensed:700|Oxygen+Mono|Source+Sans+Pro:700|Source+Serif+Pro&amp;display=swap">
    <link rel="stylesheet" href="../../../assets/css/main.css">
    <script>
      // SETUP GLOBAL CONSTANTS
      var base_url = '../../..';
      
      var telemetryEnabled = false;
      var backendUrl = "";
      var courseSlug = "";
      
      
      var dashboardEnabled = false;
      var tagTree = {};
      

      // SETUP PLUGIN
      window.initialized = false;
      if (!window.initializers) window.initializers = [];
      window.registerInitializer = (initialize) => {
        if (window.initialized) initialize();
        else window.initializers.push(initialize);
      };
    </script>
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"] ],
          processEscapes: true
        }
      });
    </script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script src="https://unpkg.com/hyperscript.org"></script>
    <script src="https://unpkg.com/htmx.org@1.8.4"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="../../../assets/js/main.js"></script>
    
    <link rel="stylesheet" href="../../../css/termynal.css">
  </head>
  <body>
    <div class="ah-main-container">
      <header class="ah-header">
        <button class="ah-menu-btn ah-button ah-button--borderless"
                aria-label="toggle menu">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512">
  <!--! Font Awesome Pro 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2022 Fonticons, Inc. -->
  <path d="M0 96C0 78.3 14.3 64 32 64H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32C14.3 128 0 113.7 0 96zM0 256c0-17.7 14.3-32 32-32H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32c-17.7 0-32-14.3-32-32zM448 416c0 17.7-14.3 32-32 32H32c-17.7 0-32-14.3-32-32s14.3-32 32-32H416c17.7 0 32 14.3 32 32z"/>
</svg>
        </button>
        <a href="../../.."
           title="MLOps &amp; Interviews"
           class="ah-logo"
           aria-label="MLOps & Interviews">
          MLOps &amp; Interviews
        </a>
        <div class="ah-header--right">
          
          
          
          <button id="resetHandoutButton">
            <span class="icon"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" class="bi bi-trash3" viewBox="0 0 16 16">
  <path d="M6.5 1h3a.5.5 0 0 1 .5.5v1H6v-1a.5.5 0 0 1 .5-.5ZM11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3A1.5 1.5 0 0 0 5 1.5v1H2.506a.58.58 0 0 0-.01 0H1.5a.5.5 0 0 0 0 1h.538l.853 10.66A2 2 0 0 0 4.885 16h6.23a2 2 0 0 0 1.994-1.84l.853-10.66h.538a.5.5 0 0 0 0-1h-.995a.59.59 0 0 0-.01 0H11Zm1.958 1-.846 10.58a1 1 0 0 1-.997.92h-6.23a1 1 0 0 1-.997-.92L3.042 3.5h9.916Zm-7.487 1a.5.5 0 0 1 .528.47l.5 8.5a.5.5 0 0 1-.998.06L5 5.03a.5.5 0 0 1 .47-.53Zm5.058 0a.5.5 0 0 1 .47.53l-.5 8.5a.5.5 0 1 1-.998-.06l.5-8.5a.5.5 0 0 1 .528-.47ZM8 4.5a.5.5 0 0 1 .5.5v8.5a.5.5 0 0 1-1 0V5a.5.5 0 0 1 .5-.5Z"/>
</svg></span>
          </button>
          

          
        </div>
      </header>
      <nav class="ah-navigation preload">
        <div class="ah-nav-container">
          <button class="ah-menu-btn ah-button ah-button--borderless close-menu"
                  aria-label="close menu">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512">
  <!--! Font Awesome Pro 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2022 Fonticons, Inc. -->
  <path d="M310.6 150.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L160 210.7 54.6 105.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3L114.7 256 9.4 361.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0L160 301.3 265.4 406.6c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L205.3 256 310.6 150.6z"/>
</svg>
          </button>
          <ul class="ah-nav-body">
            
              
  
    <li>
      <a href="../../..">Home</a>
    </li>
  

            
              
  
    <li>
      <a href="../../../about/">About</a>
    </li>
  

            
              
  
    <li>
      <a href="../../../deadlines/">Deadlines</a>
    </li>
  

            
              
  <li class="ah-togglable-item opened">
    <span class="ah-togglable-handle">Content</span>
    <ul>
      
        
  <li class="ah-togglable-item">
    <span class="ah-togglable-handle">01 - Introduction</span>
    <ul>
      
        
  
    <li>
      <a href="../../01-intro/intro/">Intro</a>
    </li>
  

      
        
  
    <li>
      <a href="../../01-intro/aps01/">Aps01</a>
    </li>
  

      
    </ul>
  </li>

      
        
  <li class="ah-togglable-item">
    <span class="ah-togglable-handle">02 - Deploy: first try!</span>
    <ul>
      
        
  
    <li>
      <a href="../../02-api/api_deploy/">Api deploy</a>
    </li>
  

      
    </ul>
  </li>

      
        
  <li class="ah-togglable-item opened">
    <span class="ah-togglable-handle">03 - Batch prediction</span>
    <ul>
      
        
  <li class="ah-togglable-item">
    <span class="ah-togglable-handle">Part 1</span>
    <ul>
      
        
  
    <li>
      <a href="../intro/">Intro</a>
    </li>
  

      
        
  
    <li>
      <a href="../data_formats/">Data formats</a>
    </li>
  

      
        
  
    <li>
      <a href="../practicing/">Practicing</a>
    </li>
  

      
    </ul>
  </li>

      
        
  <li class="ah-togglable-item opened">
    <span class="ah-togglable-handle">Part 2</span>
    <ul>
      
        
  
    <li>
      <a href="../sql/">Sql</a>
    </li>
  

      
        
  
    <li>
      <a href="../db_tool/">Db tool</a>
    </li>
  

      
        
  
    <li>
      <a href="../dot_env/">Dot env</a>
    </li>
  

      
        
  

    <li class="active ah-togglable-item opened">
      <span class="ah-togglable-handle">Aps02 sql</span>
      <ul>
        
          
            
            
              <li class="ah-toc-item">
                <a href="#before-starting">Before starting</a>
              </li>
            
              <li class="ah-toc-item">
                <a href="#configure-assignment-repository">Configure assignment repository</a>
              </li>
            
              <li class="ah-toc-item">
                <a href="#task-0-create-analytical-table">TASK 0: Create analytical table</a>
              </li>
            
              <li class="ah-toc-item">
                <a href="#task-1-query-file-for-analytical-table">TASK 1: Query file for analytical table</a>
              </li>
            
              <li class="ah-toc-item">
                <a href="#task-2-exporting-predictions">TASK 2: Exporting predictions</a>
              </li>
            
              <li class="ah-toc-item">
                <a href="#task-3-a-new-view">TASK 3: A new View!</a>
              </li>
            
        
      </ul>
    </li>
  

      
    </ul>
  </li>

      
    </ul>
  </li>

      
        
  <li class="ah-togglable-item">
    <span class="ah-togglable-handle">04 - Interview 01</span>
    <ul>
      
        
  
    <li>
      <a href="../../04-int01/faq/">Faq</a>
    </li>
  

      
        
  
    <li>
      <a href="../../04-int01/int01/">Int01</a>
    </li>
  

      
    </ul>
  </li>

      
        
  <li class="ah-togglable-item">
    <span class="ah-togglable-handle">05 - Docker</span>
    <ul>
      
        
  
    <li>
      <a href="../../05-docker/intro/">Intro</a>
    </li>
  

      
        
  
    <li>
      <a href="../../05-docker/s3/">S3</a>
    </li>
  

      
        
  
    <li>
      <a href="../../05-docker/docker/">Docker</a>
    </li>
  

      
    </ul>
  </li>

      
    </ul>
  </li>

            
          </ul>
        </div>
      </nav>
      <main class="ah-content ah-typeset">
        
          <div class="ah-title-box">
            <ul class="ah-breadcrumbs">
              
                
                  
                    <li>Content</li>
                  
                
                  
                    <li>03 - Batch prediction</li>
                  
                
                  
                    <li>Part 2</li>
                  
                
                <li></li>
            </ul>
            
            
          </div>
          
            <section class="progress-section show">
<h1 id="aps-02">APS 02</h1>
<p>In this assignment, we are going to create a new version of the work from the <a href="../practicing/">last class (Click!)</a>.</p>
<div class="admonition info">
<p class="admonition-title">What will change?!</p>
<p>All data will be read and written from PostgreSQL.</p>
</div>
<h2 id="before-starting">Before starting</h2>
<h3 id="accept-assignment">Accept assignment</h3>
<p>All assignments delivery will be made using Git repositories. Access the link below to accept the invitation and start working on the second assignment.</p>
<p><a class="ah-button" href="https://classroom.github.com/a/L0W-9jWI">Invitation link</a></p>
<h2 id="configure-assignment-repository">Configure assignment repository</h2>
<p>You must ensure that the repository has the required folder structure. Create by hand or use your template and then link to the assignment repository.</p>
<p><img alt="" src="../folder_structure.png" /></p>
<h2 id="task-0-create-analytical-table">TASK 0: Create analytical table</h2>
<p>In DBeaver, try to create a <em>SQL query</em> that performs the necessary transformations in the data of the <code>item_sale</code> table, so that they are grouped and with the necessary fields for <em>model training</em>, as in the last class.</p>
<table>
<thead>
<tr>
<th style="text-align: right;"></th>
<th style="text-align: right;">store_id</th>
<th style="text-align: right;">total_sales</th>
<th style="text-align: right;">year</th>
<th style="text-align: right;">month</th>
<th style="text-align: right;">day</th>
<th style="text-align: right;">weekday</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: right;">0</td>
<td style="text-align: right;">5000</td>
<td style="text-align: right;">62895.6</td>
<td style="text-align: right;">2023</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">6</td>
</tr>
<tr>
<td style="text-align: right;">1</td>
<td style="text-align: right;">5000</td>
<td style="text-align: right;">42351.1</td>
<td style="text-align: right;">2023</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">0</td>
</tr>
<tr>
<td style="text-align: right;">...</td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
</tr>
<tr>
<td style="text-align: right;">1636</td>
<td style="text-align: right;">5005</td>
<td style="text-align: right;">46246.3</td>
<td style="text-align: right;">2023</td>
<td style="text-align: right;">9</td>
<td style="text-align: right;">29</td>
<td style="text-align: right;">4</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="admonition-title">Tip! 1</p>
<p>Start with a simple query like:</p>
<div class="language-sql highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">SELECT</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="w">    </span><span class="n">store_id</span><span class="p">,</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="w">    </span><span class="n">client_id</span><span class="p">,</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="w">    </span><span class="n">product_id</span><span class="p">,</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="w">    </span><span class="n">date_sale</span><span class="p">,</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="w">    </span><span class="n">price</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="k">FROM</span><span class="w"> </span><span class="n">sales</span><span class="p">.</span><span class="n">item_sale</span><span class="p">;</span>
</code></pre></div>
<p>Then make the necessary adjustments.</p>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip! 2</p>
<p>At first, use <strong>fixed dates</strong>, for example, assuming your model will use data from <code>2023-06-01</code> to <code>2023-06-30</code>.</p>
</div>
<div class="admonition attention">
<p class="admonition-title">Attention</p>
<p>Notice that the query must do all necessary transformations on the data.</p>
</div>
<div class="admonition exercise self-progress" data-slug="modules/03-batch/aps02_sql/exercise_1" id="exercise_1_0">
<p class="admonition-title">Question 1</p>
<form class="exercise-form">
<p>The current day (today) will not have reliable base sales as they are still being made by customers. Adjust your query so that the data is:</p>
<ul>
<li>From the day before today</li>
<li>Up to a <code>delta</code> in the past. Choose your <code>delta</code>, for example one years.</li>
</ul>
<div class="form-elements">
<input type="hidden" name="data" value="OK" />
<input class="ah-button ah-button--primary" type="submit" name="Enviar" value="Marcar como feito" />
</div>
</form>
</div>
<div class="admonition danger">
<p class="admonition-title">Important!</p>
<p>Now "today" cannot be fixed in the query anymore, google for <code>CURRENT_DATE</code> + postgres and make the necessary adjustments!</p>
</div>
<h2 id="task-1-query-file-for-analytical-table">TASK 1: Query file for analytical table</h2>
<p>We will no longer have <em>CSV</em> in the <code>data</code> folder!</p>
<div class="admonition exercise self-progress" data-slug="modules/03-batch/aps02_sql/exercise_2" id="exercise_2_0">
<p class="admonition-title">Question 2</p>
<form class="exercise-form">
<p>Create an <code>.env</code> file with the database access credentials.</p>
<div class="form-elements">
<input type="hidden" name="data" value="OK" />
<input class="ah-button ah-button--primary" type="submit" name="Enviar" value="Marcar como feito" />
</div>
</form>
</div>
<div class="admonition exercise self-progress" data-slug="modules/03-batch/aps02_sql/exercise_3" id="exercise_3_0">
<p class="admonition-title">Question 3</p>
<form class="exercise-form">
<p>Create a <code>data/train.sql</code> file containing the query from the previous task.</p>
<div class="form-elements">
<input type="hidden" name="data" value="OK" />
<input class="ah-button ah-button--primary" type="submit" name="Enviar" value="Marcar como feito" />
</div>
</form>
</div>
<div class="admonition exercise self-progress" data-slug="modules/03-batch/aps02_sql/exercise_4" id="exercise_4_0">
<p class="admonition-title">Question 4</p>
<form class="exercise-form">
<p>Change your program so that:</p>
<ul>
<li>The <code>data/train.sql</code> file is read as text.</li>
<li>Database credencials are loaded from <code>.env</code> file.</li>
<li>Text query is executed to return a Pandas DataFrame in the model retraining step.</li>
</ul>
<div class="form-elements">
<input type="hidden" name="data" value="OK" />
<input class="ah-button ah-button--primary" type="submit" name="Enviar" value="Marcar como feito" />
</div>
</form>
</div>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>Search how to:</p>
<ul>
<li>Create a PostgreSQL database connection in Python.</li>
<li>How to read a Pandas DataFrame from a query and connection.</li>
</ul>
</div>
<div class="admonition warning">
<p class="admonition-title">For now...</p>
<p>For now, keep saving and reading the model in the <code>models</code> folder!</p>
</div>
<div class="admonition exercise text long tag-long-text tag-text-exercise editable" data-slug="modules/03-batch/aps02_sql/long_1" id="long_1_0">
<p class="admonition-title">Question 5<button class="editable-button"></button></p>
<form class="exercise-form">
<p>Why should we avoid using <code>*</code> in production queries?</p>
<p>Explain why making queries like this one is a bad practice:</p>
<div class="language-sql highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">som_table</span>
</code></pre></div>
<div class="form-elements">
<div class="grow-wrap"><textarea name="data"></textarea></div>

<input class="ah-button ah-button--primary" type="submit" value="Enviar"/>
</div>
</form>
</div>
<h2 id="task-2-exporting-predictions">TASK 2: Exporting predictions</h2>
<p>The way data predicted by the model are saved depends a lot on how the model is used.</p>
<p>In this activity, let's assume that:</p>
<ul>
<li>The model always makes predictions from the current day to the next six days.</li>
<li>The predictions are stored in another <code>schema</code> called <code>sales_analytics</code>.</li>
<li>Old predictions are not stored. Whichever prediction script is run, the table that stores predictions should be cleared and only the predictions for the day through the next week should be kept in the table.</li>
</ul>
<div class="admonition bug">
<p class="admonition-title">Challenge</p>
<p>Try to create a query that generates a table with all the days and fields needed for prediction:</p>
<p><img alt="" src="../predict_dates.png" /></p>
<p>Then, save these lines in a new table <code>"scoring_ml_YOUR_INSPER_USERNAME"</code> on schema <code>sales_analytics</code>. In Python, iterate over these records calling and storing your model's predictions!</p>
<p>Remember to delete old records from this table every time you make predictions.</p>
</div>
<div class="admonition exercise self-progress" data-slug="modules/03-batch/aps02_sql/exercise_5" id="exercise_5_0">
<p class="admonition-title">Question 6</p>
<form class="exercise-form">
<p>Change your prediction code to meet the requested requirements.</p>
<div class="form-elements">
<input type="hidden" name="data" value="OK" />
<input class="ah-button ah-button--primary" type="submit" name="Enviar" value="Marcar como feito" />
</div>
</form>
</div>
<h2 id="task-3-a-new-view">TASK 3: A new View!</h2>
<p>Let's pass the code from <code>data/train.sql</code> to a view on the database.</p>
<div class="admonition exercise self-progress" data-slug="modules/03-batch/aps02_sql/exercise_6" id="exercise_6_0">
<p class="admonition-title">Question 7</p>
<form class="exercise-form">
<p>Create a view with the contents of <code>data/train.sql</code>. The view can be called <code>view_abt_train_YOUR_INSPER_USERNAME</code> an be on schema <code>sales_analytics</code>.</p>
<div class="form-elements">
<input type="hidden" name="data" value="OK" />
<input class="ah-button ah-button--primary" type="submit" name="Enviar" value="Marcar como feito" />
</div>
</form>
</div>
<div class="admonition exercise self-progress" data-slug="modules/03-batch/aps02_sql/exercise_7" id="exercise_7_0">
<p class="admonition-title">Question 8</p>
<form class="exercise-form">
<p>Change the query in <code>data/train.sql</code> to query the newly created view.</p>
<p>DO NOT use <code>"SELECT *"</code>!!!</p>
<div class="form-elements">
<input type="hidden" name="data" value="OK" />
<input class="ah-button ah-button--primary" type="submit" name="Enviar" value="Marcar como feito" />
</div>
</form>
</div>
<p>Submit the activity by the <a href="../../../deadlines/"><strong>deadline</strong></a>!</p>


</section>
          
        
      </main>
      <footer class="ah-footer ah-typeset">
        <div class="ah-footer-nav">
          
            <a href="../dot_env/"
               class="ah-prev"
               title="Dot env">
              <span class="nav-label">Anterior</span>
              <span class="nav-title">Dot env</span>
            </a>
          
          
            <a href="../../04-int01/faq/"
               class="ah-next"
               title="Faq">
              <span class="nav-label">Próximo</span>
              <span class="nav-title">Faq</span>
            </a>
          
        </div>
      </footer>
    </div>
    
      <script src="../../../js/tabs.js"></script><script src="../../../js/termynal.js"></script><script src="../../../js/custom.js"></script>
    
  </body>
</html>